name: Deploy and Test Backend on Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Vercel CLI
        run: npm i -g vercel

      - name: Pull Vercel project settings
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel pull --yes --environment=production \
            --token "$VERCEL_TOKEN" \
            --scope "$VERCEL_ORG_ID"

      - name: Build project
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          vercel build --token "$VERCEL_TOKEN"

      - name: Deploy prebuilt to Production
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          vercel deploy --prebuilt --prod --json --token "$VERCEL_TOKEN" > deploy.json
          cat deploy.json
          DEPLOYMENT_URL=$(node -e "const fs=require('fs');const j=JSON.parse(fs.readFileSync('deploy.json','utf8'));console.log(j.url || j.deployments?.[0]?.url || '')")
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

      - name: Test API endpoints against deployment URL
        env:
          DEPLOYMENT_URL: ${{ steps.deploy.outputs.deployment_url }}
        run: |
          echo "Testing against: $DEPLOYMENT_URL"
          chmod +x ./test-api.sh
          ./test-api.sh "$DEPLOYMENT_URL"

      - name: Health check route
        env:
          DEPLOYMENT_URL: ${{ steps.deploy.outputs.deployment_url }}
        run: |
          curl -s "$DEPLOYMENT_URL/api/health" || true